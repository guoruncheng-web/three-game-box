// 水果消消乐游戏数据库 Schema
// Prisma ORM 配置

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 枚举类型 ====================

// 排行榜类型
enum LeaderboardType {
  ALL_TIME // 历史总榜
  DAILY    // 每日榜
  WEEKLY   // 每周榜
  MONTHLY  // 每月榜
}

// 成就类别
enum AchievementCategory {
  SCORE   // 分数相关
  COMBO   // 连击相关
  GAMES   // 游戏次数相关
  TIME    // 时间相关
  SPECIAL // 特殊成就
}

// ==================== 模型定义 ====================

// 用户表
model User {
  id            String   @id @default(uuid())
  username      String?  @unique
  email         String?  @unique
  avatar        String?
  isGuest       Boolean  @default(true)
  guestToken    String?  @unique

  // 游戏统计
  totalScore    Int      @default(0)
  gamesPlayed   Int      @default(0)
  highestScore  Int      @default(0)
  totalPlayTime Int      @default(0) // 秒
  level         Int      @default(1)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关系
  gameRecords         GameRecord[]
  leaderboards        Leaderboard[]
  userAchievements    UserAchievement[]
  userDailyChallenges UserDailyChallenge[]

  @@index([guestToken])
  @@index([email])
  @@index([username])
}

// 游戏记录表
model GameRecord {
  id           String   @id @default(uuid())
  userId       String
  score        Int
  moves        Int
  targetScore  Int      @default(1000)
  isWon        Boolean
  playTime     Int      // 秒
  maxCombo     Int      @default(0)
  totalMatches Int      @default(0)
  gameData     Json?    // JSON 类型
  createdAt    DateTime @default(now())

  // 关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([score(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([userId, score(sort: Desc)])
}

// 排行榜表
model Leaderboard {
  id        String          @id @default(uuid())
  userId    String
  type      LeaderboardType
  score     Int
  rank      Int
  period    String          // "all", "2026-01-12", "2026-W02", "2026-01"
  metadata  Json?           // JSON 类型
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // 关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, period])
  @@index([type, period, score(sort: Desc)])
}

// 成就表
model Achievement {
  id          String              @id @default(uuid())
  code        String              @unique
  name        String
  description String
  icon        String
  category    AchievementCategory
  condition   Json                // JSON 类型: {"type": "score", "target": 5000, "operator": "gte"}
  reward      Int                 @default(0)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())

  // 关系
  userAchievements UserAchievement[]

  @@index([code])
  @@index([category])
}

// 用户成就关联表
model UserAchievement {
  id            String    @id @default(uuid())
  userId        String
  achievementId String
  progress      Int       @default(0)
  isUnlocked    Boolean   @default(false)
  unlockedAt    DateTime?
  createdAt     DateTime  @default(now())

  // 关系
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
}

// 每日挑战表
model DailyChallenge {
  id          String   @id @default(uuid())
  date        DateTime @unique
  name        String
  description String
  targetScore Int
  targetMoves Int
  reward      Int      @default(100)
  config      Json?    // JSON 类型
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // 关系
  userDailyChallenges UserDailyChallenge[]

  @@index([date])
  @@index([isActive])
}

// 用户每日挑战记录
model UserDailyChallenge {
  id          String    @id @default(uuid())
  userId      String
  challengeId String
  score       Int
  isCompleted Boolean   @default(false)
  attempts    Int       @default(1)
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  // 关系
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([userId, isCompleted])
}
